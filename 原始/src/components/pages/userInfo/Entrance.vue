<template>
    <div class="w-full h-full bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
        <!-- ËÉåÊôØË£ÖÈ•∞ÂÖÉÁ¥† -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-blue-400/20 to-purple-400/20 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-br from-indigo-400/20 to-pink-400/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="relative w-full h-full flex gap-6 p-6">
            <!-- Â∑¶‰æßÊëÑÂÉèÂ§¥Âå∫Âüü -->
            <div class="h-full w-1/2">
                <div class="w-full h-full flex flex-col p-6 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 hover:shadow-3xl transition-all duration-500">
                    <!-- Ê†áÈ¢òÂíåÊèêÁ§∫ -->
                    <div class="mb-8 text-center relative">
                        <!-- Ë£ÖÈ•∞ÊÄßÂõæÊ†á -->
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 w-16 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>

                        <div class="flex items-center justify-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">ÂÖ•Âú∫ËΩ¶ÁâåËØÜÂà´</h2>
                        </div>

                        <div class="relative">
                            <p class="text-xl text-gray-600 font-medium">ËØ∑Â∞ÜËΩ¶ËæÜÂÅúÂú®ÊëÑÂÉèÂ§¥ÂâçÊñπ</p>
                        </div>
                    </div>
                    <!-- ÊëÑÂÉèÂ§¥ÈÄâÊã©Âô® -->
                    <div class="mb-6">
                        <label class="flex items-center text-sm font-semibold text-gray-700 mb-3">
                            <div class="w-5 h-5 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mr-2 flex items-center justify-center">
                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            ÈÄâÊã©ÊëÑÂÉèÂ§¥ËÆæÂ§á
                        </label>
                        <div class="relative">
                            <select
                                v-model="selectedDeviceId"
                                @change="switchCamera"
                                class="w-full px-4 py-3 bg-white/70 backdrop-blur-sm border-2 border-gray-200/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all duration-300 appearance-none cursor-pointer hover:border-blue-400/50"
                            >
                                <option value="">üé• ËØ∑ÈÄâÊã©ÊëÑÂÉèÂ§¥ËÆæÂ§á</option>
                                <option
                                    v-for="device in videoDevices"
                                    :key="device.deviceId"
                                    :value="device.deviceId"
                                >
                                    üìπ {{ device.label || `ÊëÑÂÉèÂ§¥ ${device.deviceId.slice(0, 8)}` }}
                                </option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- ËßÜÈ¢ëÊòæÁ§∫Âå∫Âüü -->
                    <div class="flex-1 relative bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl overflow-hidden shadow-inner border-2 border-gray-200/50">
                        <video
                            ref="videoRef"
                            autoplay
                            playsinline
                            muted
                            class="w-full h-full object-cover"
                            v-show="isVideoActive"
                        ></video>



                        <!-- ËßíËêΩË£ÖÈ•∞ -->
                        <div class="absolute top-4 left-4 w-6 h-6 border-l-2 border-t-2 border-blue-400 opacity-60" v-show="isVideoActive"></div>
                        <div class="absolute top-4 right-4 w-6 h-6 border-r-2 border-t-2 border-blue-400 opacity-60" v-show="isVideoActive"></div>
                        <div class="absolute bottom-4 left-4 w-6 h-6 border-l-2 border-b-2 border-blue-400 opacity-60" v-show="isVideoActive"></div>
                        <div class="absolute bottom-4 right-4 w-6 h-6 border-r-2 border-b-2 border-blue-400 opacity-60" v-show="isVideoActive"></div>



                        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                        <div
                            v-if="isLoading"
                            class="absolute inset-0 bg-gradient-to-br from-blue-900/80 to-purple-900/80 backdrop-blur-sm flex items-center justify-center"
                        >
                            <div class="text-white text-center">
                                <div class="relative mb-6">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-white/20 border-t-white mx-auto"></div>
                                    <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-blue-400 animate-spin" style="animation-duration: 1.5s; animation-direction: reverse;"></div>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-lg font-semibold">üé• Ê≠£Âú®ÂêØÂä®ÊëÑÂÉèÂ§¥</p>
                                    <p class="text-sm text-blue-200">ËØ∑Á®çÂÄôÔºåÊ≠£Âú®ËøûÊé•ËÆæÂ§á...</p>
                                </div>
                            </div>
                        </div>

                        <!-- ÈîôËØØÁä∂ÊÄÅ -->
                        <div
                            v-if="error"
                            class="absolute inset-0 bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center"
                        >
                            <div class="text-center text-red-600 max-w-md mx-auto p-6">
                                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold mb-4">‚ö†Ô∏è ÊëÑÂÉèÂ§¥ÂêØÂä®Â§±Ë¥•</h3>
                                
                                <!-- ÈîôËØØ‰ø°ÊÅØÊòæÁ§∫ -->
                                <div class="text-left text-sm text-red-600 mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
                                    <div v-if="error.includes('\n')" class="space-y-2">
                                        <div v-for="(line, index) in error.split('\n')" :key="index" class="flex items-start">
                                            <span v-if="line.match(/^\d+\./)"
                                                  class="inline-block w-full text-left font-medium">{{ line }}</span>
                                            <span v-else class="inline-block w-full text-left"
                                                  :class="index === 0 ? 'font-semibold text-red-700' : ''">{{ line }}</span>
                                        </div>
                                    </div>
                                    <div v-else class="font-medium">{{ error }}</div>
                                </div>
                                
                                <!-- Êìç‰ΩúÊåâÈíÆ -->
                                <div class="space-y-2">
                                    <div class="flex space-x-2 justify-center">
                                        <button
                                            @click="initCamera"
                                            class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-200 text-sm font-medium shadow-lg hover:shadow-xl transform hover:scale-105"
                                        >
                                            üîÑ ÈáçÊñ∞Áî≥ËØ∑ÊùÉÈôê
                                        </button>
                                        <button
                                            @click="refreshPage"
                                            class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-2 rounded-lg transition-all duration-200 text-sm font-medium shadow-lg hover:shadow-xl transform hover:scale-105"
                                        >
                                            üîÉ Âà∑Êñ∞È°µÈù¢
                                        </button>
                                    </div>
                                    
                                    <!-- È¢ùÂ§ñÁöÑÂ∏ÆÂä©ÊåâÈíÆ -->
                                    <div class="text-center">
                                        <button
                                            @click="showCameraHelp"
                                            class="text-blue-600 hover:text-blue-800 text-xs underline transition-colors duration-200"
                                        >
                                            üìñ Êü•ÁúãËØ¶ÁªÜÂ∏ÆÂä©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            v-if="!isVideoActive && !isLoading && !error"
                            class="absolute inset-0 flex items-center justify-center bg-gray-100"
                        >
                            <p class="text-gray-500">ËØ∑ÈÄâÊã©ÊëÑÂÉèÂ§¥</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßÂå∫Âüü -->
            <div class="h-full w-1/2">
                <div class="w-full h-full flex flex-col p-5 bg-white rounded-lg shadow-md">
                    <!-- ‰∏äÈÉ®ÂàÜÔºöËΩ¶ÁâåËØÜÂà´ÁªìÊûúÂíåÂàÜÈÖçËΩ¶‰Ωç (1/3) -->
                    <div class="h-1/3 flex gap-4 mb-4">
                    <!-- Â∑¶‰æßÂç°ÁâáÔºöËΩ¶ÁâåËØÜÂà´ÁªìÊûú -->
                    <div class="w-1/2 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl shadow-lg p-3 border border-blue-200 overflow-hidden">
                        <div class="flex items-center mb-2">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center mr-2 transition-all duration-300"
                                :class="isDetecting ? 'bg-yellow-500 animate-pulse' : licensePlate ? 'bg-green-500' : 'bg-blue-500'"
                            >
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path v-if="isDetecting" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path v-else-if="licensePlate" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path v-else stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800">
                                {{ isDetecting ? 'Ê≠£Âú®ËØÜÂà´...' : licensePlate ? 'ËØÜÂà´ÂÆåÊàê' : 'ËΩ¶ÁâåËØÜÂà´ÁªìÊûú' }}
                            </h3>
                        </div>

                        <!-- ËΩ¶ÁâåÂè∑Á†ÅÊòæÁ§∫ -->
                        <div class="bg-white rounded-lg p-2 mb-2 shadow-inner border-2 border-dashed border-blue-300">
                            <div class="text-center">
                                <div class="text-xl font-bold text-blue-700 tracking-wider font-mono">
                                    {{ licensePlate || 'Á≠âÂæÖËØÜÂà´...' }}
                                </div>
                                <div class="text-xs text-gray-500">License Plate Number</div>
                            </div>
                        </div>

                        <!-- ËØ¶ÁªÜ‰ø°ÊÅØ -->
                        <div class="space-y-1">
                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">ËØÜÂà´ÂèØ‰ø°Â∫¶</span>
                                <div class="flex items-center">
                                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mr-1">
                                        <div
                                            class="h-1.5 rounded-full transition-all duration-300"
                                            :class="confidence >= 80 ? 'bg-green-500' : confidence >= 60 ? 'bg-yellow-500' : 'bg-red-500'"
                                            :style="{ width: `${Math.min(confidence, 100)}%` }"
                                        ></div>
                                    </div>
                                    <span
                                        class="text-xs font-bold"
                                        :class="confidence >= 80 ? 'text-green-600' : confidence >= 60 ? 'text-yellow-600' : 'text-red-600'"
                                    >
                                        {{ confidence }}%
                                    </span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">ËΩ¶ËæÜÁ±ªÂûã</span>
                                <span
                                    class="text-xs font-semibold px-2 py-1 rounded-full"
                                    :class="vehicleType === 'Êñ∞ËÉΩÊ∫êÊ±ΩËΩ¶' ? 'text-green-600 bg-green-100' : 'text-blue-600 bg-blue-100'"
                                >
                                    {{ vehicleType || 'Êú™ËØÜÂà´' }}
                                </span>
                            </div>

                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">ËøõÂú∫Êó∂Èó¥</span>
                                <span class="text-xs font-mono text-gray-800">
                                    {{ entryTime || '--' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Âè≥‰æßÂç°ÁâáÔºöÂàÜÈÖçËΩ¶‰Ωç -->
                    <div
                        class="w-1/2 rounded-xl shadow-lg p-3 border overflow-hidden transition-all duration-300"
                        :class="assignedSpot ? 'bg-gradient-to-br from-green-50 to-emerald-100 border-green-200' : 'bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200'"
                    >
                        <div class="flex items-center mb-2">
                            <div
                                class="w-6 h-6 rounded-full flex items-center justify-center mr-2 transition-all duration-300"
                                :class="assignedSpot ? 'bg-green-500' : 'bg-gray-400'"
                            >
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path v-if="assignedSpot" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path v-if="assignedSpot" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path v-else stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3
                                class="text-lg font-bold transition-all duration-300"
                                :class="assignedSpot ? 'text-gray-800' : 'text-gray-600'"
                            >
                                {{ assignedSpot ? '‰∏∫ÊÇ®ÂàÜÈÖçÁöÑËΩ¶‰Ωç' : 'Á≠âÂæÖÂàÜÈÖçËΩ¶‰Ωç' }}
                            </h3>
                        </div>

                        <!-- ËΩ¶‰ΩçÂè∑Á†ÅÊòæÁ§∫ -->
                        <div class="bg-white rounded-lg p-3 mb-2 shadow-inner border-2 border-dashed border-green-300">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-700 tracking-wider font-mono">
                                    {{ assignedSpot || '--' }}
                                </div>
                                <div class="text-xs text-gray-500">Assigned Parking Space</div>
                            </div>
                        </div>

                        <!-- ËØ¶ÁªÜ‰ø°ÊÅØ -->
                        <div class="space-y-1">
                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">Ë∑ùÁ¶ªÂÖ•Âè£</span>
                                <div class="flex items-center">
                                    <svg class="w-3 h-3 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                    <span class="text-xs font-bold text-green-600">
                                        {{ spotDistance || '--' }}
                                    </span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">È¢ÑËÆ°Ê≠•Ë°åÊó∂Èó¥</span>
                                <span class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-1 rounded-full">
                                    {{ walkTime || '--' }}
                                </span>
                            </div>

                            <div class="flex items-center justify-between bg-white/60 rounded-lg p-2">
                                <span class="text-xs font-medium text-gray-700">ËΩ¶‰ΩçÁä∂ÊÄÅ</span>
                                <div class="flex items-center">
                                    <div
                                        class="w-2 h-2 rounded-full mr-1"
                                        :class="spotStatus ? 'bg-green-500 animate-pulse' : 'bg-gray-400'"
                                    ></div>
                                    <span class="text-xs font-mono text-green-700">
                                        {{ spotStatus || 'Á≠âÂæÖÂàÜÈÖç' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏ãÈÉ®ÂàÜÔºöÂÅúËΩ¶Âú∫Áº©Áï•Âõæ (2/3) -->
                <div class="flex-1 bg-gray-50 rounded-lg p-2 overflow-hidden">
                    <h3 class="text-sm font-bold text-gray-800 mb-2">ÂÅúËΩ¶Âú∫Â∏ÉÂ±ÄÂõæ</h3>
                    <div class="w-full h-full bg-gray-100 rounded-lg relative overflow-hidden p-2">
                        <!-- ÂÅúËΩ¶Âú∫Áº©Áï•ÂõæÂÜÖÂÆπ - ‰∏éadmin dashboard‰øùÊåÅ‰∏ÄËá¥ -->
                        <div class="parking-layout-thumbnail h-full">
                            <!-- ÂÖ•Âè£Ê†áËØÜ -->
                            <div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded">
                                ÂÖ•Âè£
                            </div>

                            <!-- ÂÅúËΩ¶Âå∫ÂüüÂ∏ÉÂ±Ä -->
                            <div class="grid grid-cols-2 gap-4 h-full pt-2 pb-6">
                                <!-- AÂå∫ -->
                                <div class="area-section">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2 text-center">AÂå∫</h4>
                                    <div class="flex justify-center gap-1 flex-wrap">
                                        <div v-for="i in 5" :key="'A' + i"
                                             class="parking-space-mini"
                                             :class="getSpotClass(`A${String(i).padStart(3, '0')}`)">
                                            <div class="space-content-mini">
                                                <div class="space-id-mini">A{{ String(i).padStart(2, '0') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- BÂå∫ -->
                                <div class="area-section">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2 text-center">BÂå∫</h4>
                                    <div class="flex justify-center gap-1 flex-wrap">
                                        <div v-for="i in 5" :key="'B' + i"
                                             class="parking-space-mini"
                                             :class="getSpotClass(`B${String(i).padStart(3, '0')}`)">
                                            <div class="space-content-mini">
                                                <div class="space-id-mini">B{{ String(i).padStart(2, '0') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CÂå∫ -->
                                <div class="area-section">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2 text-center">CÂå∫</h4>
                                    <div class="flex justify-center gap-1 flex-wrap">
                                        <div v-for="i in 5" :key="'C' + i"
                                             class="parking-space-mini"
                                             :class="getSpotClass(`C${String(i).padStart(3, '0')}`)">
                                            <div class="space-content-mini">
                                                <div class="space-id-mini">C{{ String(i).padStart(2, '0') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- DÂå∫ -->
                                <div class="area-section">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2 text-center">DÂå∫</h4>
                                    <div class="flex justify-center gap-1 flex-wrap">
                                        <div v-for="i in 5" :key="'D' + i"
                                             class="parking-space-mini"
                                             :class="getSpotClass(`D${String(i).padStart(3, '0')}`)">
                                            <div class="space-content-mini">
                                                <div class="space-id-mini">D{{ String(i).padStart(2, '0') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, inject } from 'vue'
import WebSocketClient from '@/http/WebSocket'
import { autoAssignParkingSpot, getParkingLayout } from '@/api/user/parking'
import { useUserStore } from '@/stores/auth/user'

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const videoRef = ref<HTMLVideoElement | null>(null)
const videoDevices = ref<MediaDeviceInfo[]>([])
const selectedDeviceId = ref<string>('')
const currentStream = ref<MediaStream | null>(null)
const isVideoActive = ref(false)
const isLoading = ref(false)
const error = ref<string>('')

// WebSocketÁõ∏ÂÖ≥
const wsClient = ref<WebSocketClient | null>(null)
const canvasRef = ref<HTMLCanvasElement | null>(null)
let frameInterval: number | null = null

// ËΩ¶ÁâåÊ£ÄÊµãÁªìÊûúÁõ∏ÂÖ≥
const detectionResult = ref<any>(null)
const licensePlate = ref<string>('')
const confidence = ref<number>(0)
const vehicleType = ref<string>('')
const entryTime = ref<string>('')
const assignedSpot = ref<string>('')
const spotDistance = ref<string>('')
const walkTime = ref<string>('')
const spotStatus = ref<string>('')
const sessionId = ref<string>('')
const isDetecting = ref<boolean>(false)

// ÂÅúËΩ¶Âú∫Â∏ÉÂ±Ä‰ø°ÊÅØ
const parkingLayout = ref({
    A: ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08'],
    B: ['B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08'],
    C: ['C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08'],
    D: ['D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D08']
})

// Ëé∑ÂèñÁà∂ÁªÑ‰ª∂ÁöÑÁî®Êà∑‰ø°ÊÅØ
const parentUserInfo = inject('userMembershipInfo', ref({
    is_member: false,
    license_plate: '',
    preferred_area: ''
}))

// Ëé∑ÂèñÁî®Êà∑Â≠òÂÇ®
const userStore = useUserStore()

// Ëé∑ÂèñËΩ¶‰ΩçÊ†∑ÂºèÁ±ª
const getSpotClass = (spotId: string) => {
    // ËΩ¨Êç¢‰∏∫Ê†áÂáÜÊ†ºÂºèËøõË°åÊØîËæÉÔºàÂéªÊéâÂâçÂØºÈõ∂Ôºâ
    const normalizedSpotId = spotId.replace(/0+/, '')
    const normalizedAssignedSpot = assignedSpot.value?.replace(/0+/, '')

    // Â¶ÇÊûúÊòØÂàÜÈÖçÁöÑËΩ¶‰ΩçÔºå‰ΩøÁî®ÈªÑËâ≤Â∫ïËâ≤
    if (normalizedAssignedSpot && normalizedSpotId === normalizedAssignedSpot) {
        return 'assigned'
    }

    // Ê®°Êãü‰∏Ä‰∫õÂ∑≤Âç†Áî®ÁöÑËΩ¶‰ΩçÔºàÁ∫¢Ëâ≤Ôºâ
    const occupiedSpots = ['B03', 'A02', 'C04']
    if (occupiedSpots.includes(normalizedSpotId)) {
        return 'occupied'
    }

    // ÂÖ∂‰ªñ‰∏∫ÂèØÁî®ËΩ¶‰ΩçÔºàÁªøËâ≤Ôºâ
    return 'available'
}

// Áî≥ËØ∑ÊëÑÂÉèÂ§¥ÊùÉÈôê
const requestCameraPermission = async () => {
    try {
        // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅ getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            error.value = 'ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊëÑÂÉèÂ§¥ÂäüËÉΩÔºåËØ∑‰ΩøÁî®Áé∞‰ª£ÊµèËßàÂô®ÔºàChrome„ÄÅFirefox„ÄÅSafariÁ≠âÔºâ'
            return false
        }

        // ÂÖàÁî≥ËØ∑‰∏Ä‰∏™Âü∫Êú¨ÁöÑÊëÑÂÉèÂ§¥ÊùÉÈôêÔºåËøôÊ†∑ÂèØ‰ª•Ëé∑ÂèñÂà∞ËÆæÂ§áÊ†áÁ≠æ
        const stream = await navigator.mediaDevices.getUserMedia({ video: true })
        // Á´ãÂç≥ÂÅúÊ≠¢Ëøô‰∏™‰∏¥Êó∂ÊµÅ
        stream.getTracks().forEach(track => track.stop())
        return true
    } catch (err) {
        console.error('Áî≥ËØ∑ÊëÑÂÉèÂ§¥ÊùÉÈôêÂ§±Ë¥•:', err)
        if (err instanceof Error) {
            if (err.name === 'NotAllowedError') {
                error.value = 'ÊëÑÂÉèÂ§¥ÊùÉÈôêË¢´ÊãíÁªù„ÄÇËØ∑Êåâ‰ª•‰∏ãÊ≠•È™§Êìç‰ΩúÔºö\n1. ÁÇπÂáªÂú∞ÂùÄÊ†èÂ∑¶‰æßÁöÑÊëÑÂÉèÂ§¥ÂõæÊ†á\n2. ÈÄâÊã©"ÂÖÅËÆ∏"ËÆøÈóÆÊëÑÂÉèÂ§¥\n3. Âà∑Êñ∞È°µÈù¢ÈáçËØï'
            } else if (err.name === 'NotFoundError') {
                error.value = 'Êú™ÊâæÂà∞ÊëÑÂÉèÂ§¥ËÆæÂ§áÔºåËØ∑Á°Æ‰øùÔºö\n1. ÊëÑÂÉèÂ§¥Â∑≤Ê≠£Á°ÆËøûÊé•\n2. Ê≤°ÊúâË¢´ÂÖ∂‰ªñÂ∫îÁî®Âç†Áî®\n3. È©±Âä®Á®ãÂ∫èÂ∑≤ÂÆâË£Ö'
            } else if (err.name === 'NotReadableError') {
                error.value = 'ÊëÑÂÉèÂ§¥Ë¢´ÂÖ∂‰ªñÂ∫îÁî®Âç†Áî®ÔºåËØ∑Ôºö\n1. ÂÖ≥Èó≠ÂÖ∂‰ªñ‰ΩøÁî®ÊëÑÂÉèÂ§¥ÁöÑÂ∫îÁî®\n2. ÈáçÊñ∞ËøûÊé•ÊëÑÂÉèÂ§¥\n3. Âà∑Êñ∞È°µÈù¢ÈáçËØï'
            } else if (err.name === 'OverconstrainedError') {
                error.value = 'ÊëÑÂÉèÂ§¥‰∏çÊîØÊåÅËØ∑Ê±ÇÁöÑÈÖçÁΩÆÔºåËØ∑Â∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÊëÑÂÉèÂ§¥ËÆæÂ§á'
            } else {
                error.value = `ÊùÉÈôêÁî≥ËØ∑Â§±Ë¥•: ${err.message}`
            }
        } else {
            error.value = 'ÊùÉÈôêÁî≥ËØ∑Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊëÑÂÉèÂ§¥ËÆæÂ§áÂíåÊµèËßàÂô®ËÆæÁΩÆ'
        }
        return false
    }
}

// Ëé∑ÂèñÊëÑÂÉèÂ§¥ËÆæÂ§áÂàóË°®
const getVideoDevices = async () => {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices()
        videoDevices.value = devices.filter(device => device.kind === 'videoinput')

        // Â¶ÇÊûúÊúâÊëÑÂÉèÂ§¥‰∏îÊ≤°ÊúâÈÄâ‰∏≠ÁöÑËÆæÂ§áÔºåËá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™
        if (videoDevices.value.length > 0 && !selectedDeviceId.value) {
            selectedDeviceId.value = videoDevices.value[0].deviceId
        }
    } catch (err) {
        console.error('Ëé∑ÂèñÊëÑÂÉèÂ§¥ËÆæÂ§áÂ§±Ë¥•:', err)
        error.value = 'Êó†Ê≥ïËé∑ÂèñÊëÑÂÉèÂ§¥ËÆæÂ§áÂàóË°®'
    }
}

// ÂÅúÊ≠¢ÂΩìÂâçËßÜÈ¢ëÊµÅ
const stopCurrentStream = () => {
    if (currentStream.value) {
        currentStream.value.getTracks().forEach(track => track.stop())
        currentStream.value = null
    }
    isVideoActive.value = false
    stopFrameCapture()
}

// ÂêØÂä®ÊëÑÂÉèÂ§¥
const startCamera = async (deviceId: string) => {
    try {
        isLoading.value = true
        error.value = ''

        // ÂÅúÊ≠¢ÂΩìÂâçÊµÅ
        stopCurrentStream()

        // Ëé∑ÂèñÊñ∞ÁöÑËßÜÈ¢ëÊµÅ
        const constraints: MediaStreamConstraints = {
            video: {
                deviceId: deviceId ? { exact: deviceId } : undefined,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        }

        const stream = await navigator.mediaDevices.getUserMedia(constraints)
        currentStream.value = stream

        // Â∞ÜÊµÅÁªëÂÆöÂà∞videoÂÖÉÁ¥†
        if (videoRef.value) {
            videoRef.value.srcObject = stream
            isVideoActive.value = true

            // Á≠âÂæÖËßÜÈ¢ëÂä†ËΩΩÂÆåÊàêÂêéÂºÄÂßãÂ∏ßÊçïËé∑
            videoRef.value.onloadedmetadata = () => {
                if (wsClient.value?.isConnected()) {
                    startFrameCapture()
                }
            }
        }

    } catch (err) {
        console.error('ÂêØÂä®ÊëÑÂÉèÂ§¥Â§±Ë¥•:', err)
        if (err instanceof Error) {
            if (err.name === 'NotAllowedError') {
                error.value = 'ÊëÑÂÉèÂ§¥ÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑ÂÖÅËÆ∏ËÆøÈóÆÊëÑÂÉèÂ§¥'
            } else if (err.name === 'NotFoundError') {
                error.value = 'Êú™ÊâæÂà∞ÊëÑÂÉèÂ§¥ËÆæÂ§á'
            } else if (err.name === 'NotReadableError') {
                error.value = 'ÊëÑÂÉèÂ§¥Ë¢´ÂÖ∂‰ªñÂ∫îÁî®Âç†Áî®'
            } else {
                error.value = `ÊëÑÂÉèÂ§¥ÂêØÂä®Â§±Ë¥•: ${err.message}`
            }
        } else {
            error.value = 'ÊëÑÂÉèÂ§¥ÂêØÂä®Â§±Ë¥•'
        }
    } finally {
        isLoading.value = false
    }
}

// ÂàáÊç¢ÊëÑÂÉèÂ§¥
const switchCamera = () => {
    if (selectedDeviceId.value) {
        startCamera(selectedDeviceId.value)
    }
}

// Âà∑Êñ∞È°µÈù¢
const refreshPage = () => {
    window.location.reload()
}

// ÊòæÁ§∫ÊëÑÂÉèÂ§¥Â∏ÆÂä©‰ø°ÊÅØ
const showCameraHelp = () => {
    const helpMessage = `ÊëÑÂÉèÂ§¥ÊùÉÈôêÈóÆÈ¢òËß£ÂÜ≥ÊñπÊ°àÔºö

üåê ChromeÊµèËßàÂô®Ôºö
1. ÁÇπÂáªÂú∞ÂùÄÊ†èÂ∑¶‰æßÁöÑÈîÅÂΩ¢ÂõæÊ†áÊàñÊëÑÂÉèÂ§¥ÂõæÊ†á
2. Â∞ÜÊëÑÂÉèÂ§¥ÊùÉÈôêËÆæÁΩÆ‰∏∫"ÂÖÅËÆ∏"
3. Âà∑Êñ∞È°µÈù¢

ü¶ä FirefoxÊµèËßàÂô®Ôºö
1. ÁÇπÂáªÂú∞ÂùÄÊ†èÂ∑¶‰æßÁöÑÁõæÁâåÂõæÊ†á
2. ÂÖ≥Èó≠"ÈòªÊ≠¢ÊëÑÂÉèÂ§¥ËÆøÈóÆ"
3. Âà∑Êñ∞È°µÈù¢

üß≠ SafariÊµèËßàÂô®Ôºö
1. Âú®ËèúÂçïÊ†èÈÄâÊã©"Safari" > "ÁΩëÁ´ôËÆæÁΩÆ"
2. ÊâæÂà∞ÊëÑÂÉèÂ§¥ÈÄâÈ°πÔºåËÆæÁΩÆ‰∏∫"ÂÖÅËÆ∏"
3. Âà∑Êñ∞È°µÈù¢

üí° ÂÖ∂‰ªñËß£ÂÜ≥ÊñπÊ°àÔºö
‚Ä¢ Á°Æ‰øùÊëÑÂÉèÂ§¥ËÆæÂ§áÊ≠£Â∏∏ËøûÊé•
‚Ä¢ ÂÖ≥Èó≠ÂÖ∂‰ªñ‰ΩøÁî®ÊëÑÂÉèÂ§¥ÁöÑÂ∫îÁî®Á®ãÂ∫è
‚Ä¢ ÈáçÂêØÊµèËßàÂô®ÊàñËÆ°ÁÆóÊú∫
‚Ä¢ Ê£ÄÊü•Èò≤ÁÅ´Â¢ôÂíåÂÆâÂÖ®ËΩØ‰ª∂ËÆæÁΩÆ

Â¶ÇÊûúÈóÆÈ¢ò‰ªçÁÑ∂Â≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ„ÄÇ`
    
    alert(helpMessage)
}

// ÂàùÂßãÂåñÊëÑÂÉèÂ§¥
const initCamera = async () => {
    // È¶ñÂÖàÁî≥ËØ∑ÊëÑÂÉèÂ§¥ÊùÉÈôê
    const hasPermission = await requestCameraPermission()
    if (!hasPermission) {
        return
    }

    // ÊùÉÈôêÁî≥ËØ∑ÊàêÂäüÂêéËé∑ÂèñËÆæÂ§áÂàóË°®
    await getVideoDevices()
    if (selectedDeviceId.value) {
        await startCamera(selectedDeviceId.value)
    }
}

// ÂàùÂßãÂåñWebSocketËøûÊé•
const initWebSocket = () => {
    wsClient.value = new WebSocketClient('ws://192.168.124.3:8002/ws/vehicle-detection/', {
        onOpen: () => {
            console.log('WebSocketËøûÊé•ÊàêÂäü')
            startFrameCapture()
        },
        onMessage: (data) => {
            console.log('Êî∂Âà∞WebSocketÊ∂àÊÅØ:', data)
            handleWebSocketMessage(data)
        },
        onClose: (event) => {
            console.log('WebSocketËøûÊé•ÂÖ≥Èó≠:', event)
            stopFrameCapture()
        },
        onError: (event) => {
            console.error('WebSocketËøûÊé•ÈîôËØØ:', event)
        }
    }, {
        reconnectInterval: 3000,
        maxReconnectAttempts: 5,
        heartbeatInterval: 30000
    })

    wsClient.value.connect()
}

// ÊçïËé∑ËßÜÈ¢ëÂ∏ßÂπ∂ËΩ¨Êç¢‰∏∫base64
const captureFrame = (): string | null => {
    if (!videoRef.value || !isVideoActive.value) {
        return null
    }

    // ÂàõÂª∫canvasÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    if (!canvasRef.value) {
        canvasRef.value = document.createElement('canvas')
    }

    const canvas = canvasRef.value
    const video = videoRef.value
    const ctx = canvas.getContext('2d')

    if (!ctx) {
        return null
    }

    // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏‰∏éËßÜÈ¢ëÁõ∏Âêå
    canvas.width = video.videoWidth
    canvas.height = video.videoHeight

    // ÁªòÂà∂ÂΩìÂâçËßÜÈ¢ëÂ∏ßÂà∞canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height)

    // ËΩ¨Êç¢‰∏∫base64
    try {
        return canvas.toDataURL('image/jpeg', 0.8).split(',')[1] // ÁßªÈô§data:image/jpeg;base64,ÂâçÁºÄ
    } catch (err) {
        console.error('ËΩ¨Êç¢ÂõæÂÉè‰∏∫base64Â§±Ë¥•:', err)
        return null
    }
}

// ÂºÄÂßãÂ∏ßÊçïËé∑ÔºàÊØèÁßí5Ê¨°Ôºâ
const startFrameCapture = () => {
    if (frameInterval) {
        clearInterval(frameInterval)
    }

    frameInterval = setInterval(() => {
        const frameBase64 = captureFrame()
        if (frameBase64 && wsClient.value?.isConnected()) {
            const message = {
                type: 'video_frame',
                frame: frameBase64
            }
            wsClient.value.send(message)
        }
    }, 200) // ÊØè200msÂèëÈÄÅ‰∏ÄÊ¨°ÔºåÂç≥ÊØèÁßí5Ê¨°
}

// ÂÅúÊ≠¢Â∏ßÊçïËé∑
const stopFrameCapture = () => {
    if (frameInterval) {
        clearInterval(frameInterval)
        frameInterval = null
    }
}

// Â§ÑÁêÜWebSocketÊ∂àÊÅØ
const handleWebSocketMessage = (data: any) => {
    try {
        const message = typeof data === 'string' ? JSON.parse(data) : data

        switch (message.type) {
            case 'connection_established':
                console.log('ËøûÊé•Â∑≤Âª∫Á´ã:', message.message)
                sessionId.value = message.session_id || ''
                break

            case 'detection_result':
                handleDetectionResult(message)
                break

            case 'spot_assignment':
                handleSpotAssignment(message)
                break

            case 'error':
                console.error('WebSocketÈîôËØØ:', message.message)
                break

            default:
                console.log('Êú™Áü•Ê∂àÊÅØÁ±ªÂûã:', message.type)
        }
    } catch (err) {
        console.error('Ëß£ÊûêWebSocketÊ∂àÊÅØÂ§±Ë¥•:', err)
    }
}

// Â§ÑÁêÜËΩ¶ÁâåÊ£ÄÊµãÁªìÊûú
const handleDetectionResult = async (message: any) => {
    isDetecting.value = true
    detectionResult.value = message

    // Êõ¥Êñ∞ËΩ¶Áâå‰ø°ÊÅØ
    if (message.license_plates && message.license_plates.length > 0) {
        licensePlate.value = message.license_plates[0]
    }

    // Êõ¥Êñ∞Ê£ÄÊµãËØ¶ÊÉÖ
    if (message.detections && message.detections.length > 0) {
        const detection = message.detections[0]
        confidence.value = Math.round(detection.confidence * 100)

        // Ê†πÊçÆÊ£ÄÊµãÁ±ªÂûãËÆæÁΩÆËΩ¶ËæÜÁ±ªÂûã
        switch (detection.class_name) {
            case 'blue':
            case 'license_plate':
                vehicleType.value = 'Â∞èÂûãÊ±ΩËΩ¶'
                break
            case 'green':
                vehicleType.value = 'Êñ∞ËÉΩÊ∫êÊ±ΩËΩ¶'
                break
            default:
                vehicleType.value = 'Êú™Áü•Á±ªÂûã'
        }
    }

    // Êõ¥Êñ∞ËøõÂú∫Êó∂Èó¥
    entryTime.value = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    })

    // ËøõË°åËΩ¶‰ΩçÂàÜÈÖç
    await performParkingSpotAssignment()
}

// Â§ÑÁêÜËΩ¶‰ΩçÂàÜÈÖçÁªìÊûú
const handleSpotAssignment = (message: any) => {
    if (message.assigned_spot) {
        assignedSpot.value = message.assigned_spot.number || ''
        spotDistance.value = message.distance || ''
        walkTime.value = message.walk_time || ''
        spotStatus.value = 'Â∑≤ÂàÜÈÖç'
    }
}

// ÊâßË°åËΩ¶‰ΩçÂàÜÈÖçÈÄªËæë
const performParkingSpotAssignment = async () => {
    try {
        const userInfo = parentUserInfo.value
        const detectedPlate = licensePlate.value

        // Âà§Êñ≠ÊòØÂê¶‰∏∫Ê≥®ÂÜåÁî®Êà∑‰∏îËΩ¶ÁâåÂåπÈÖç
        const isRegisteredUser = userInfo.is_member &&
                                userInfo.license_plate &&
                                userInfo.license_plate === detectedPlate

        let assignedSpotInfo

        if (isRegisteredUser && userInfo.preferred_area) {
            // Ê≥®ÂÜåÁî®Êà∑‰∏îËΩ¶ÁâåÂåπÈÖçÔºå‰ºòÂÖàÂàÜÈÖçÂÅèÂ•ΩÂå∫Âüü
            assignedSpotInfo = await assignSpotByPreference(userInfo.preferred_area)
        } else {
            // ÈùûÊ≥®ÂÜåÁî®Êà∑ÊàñËΩ¶Áâå‰∏çÂåπÈÖçÔºåÈöèÊú∫ÂàÜÈÖç
            assignedSpotInfo = await assignRandomSpot()
        }

        if (assignedSpotInfo) {
            assignedSpot.value = assignedSpotInfo.spot_number
            spotDistance.value = assignedSpotInfo.distance || `${Math.floor(Math.random() * 200 + 50)}Á±≥`
            walkTime.value = assignedSpotInfo.walk_time || `${Math.floor(Math.random() * 3 + 1)}ÂàÜÈíü`
            spotStatus.value = 'Â∑≤ÂàÜÈÖç'
        }

    } catch (error) {
        console.error('ËΩ¶‰ΩçÂàÜÈÖçÂ§±Ë¥•:', error)
        // ÂàÜÈÖçÂ§±Ë¥•Êó∂‰ΩøÁî®ÈªòËÆ§ÈÄªËæë
        await assignRandomSpot()
    }
}

// Ê†πÊçÆÂÅèÂ•ΩÂå∫ÂüüÂàÜÈÖçËΩ¶‰Ωç
const assignSpotByPreference = async (preferredArea: string) => {
    try {
        const userInfo = userStore.getUserInfo()
        if (!userInfo?.user_id) {
            console.error('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÁº∫Â∞ë user_id')
            return await assignRandomSpot()
        }

        const response = await autoAssignParkingSpot({
            user_id: userInfo.user_id,
            license_plate: licensePlate.value,
            preferred_area: preferredArea,
            vehicle_type: vehicleType.value
        })

        // Ê†πÊçÆËá™ÂÆö‰πâÊåá‰ª§ÔºåAxios ËøîÂõûÁöÑÊòØ res.dataÔºåÁõ¥Êé•‰ΩøÁî® response
        if (response && response.success) {
            return {
                spot_number: response.assigned_spot.number,
                distance: response.distance || `${Math.floor(Math.random() * 200 + 50)}Á±≥`,
                walk_time: response.walk_time || `${Math.floor(Math.random() * 3 + 1)}ÂàÜÈíü`
            }
        }

        // Â¶ÇÊûúÂÅèÂ•ΩÂå∫ÂüüÊ≤°ÊúâÁ©∫‰ΩçÔºåÂ∞ùËØïÂÖ∂‰ªñÂå∫Âüü
        return await assignRandomSpot()

    } catch (error) {
        console.error('ÂÅèÂ•ΩÂå∫ÂüüÂàÜÈÖçÂ§±Ë¥•:', error)
        return await assignRandomSpot()
    }
}

// ÈöèÊú∫ÂàÜÈÖçËΩ¶‰Ωç
const assignRandomSpot = async () => {
    try {
        const userInfo = userStore.getUserInfo()
        if (!userInfo?.user_id) {
            console.error('Áî®Êà∑‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÁº∫Â∞ë user_id')
            return null
        }

        // Ëé∑ÂèñÂÅúËΩ¶Âú∫Â∏ÉÂ±Ä‰ø°ÊÅØ
        const layoutResponse = await getParkingLayout()
        let availableSpots = []

        // Ê†πÊçÆËá™ÂÆö‰πâÊåá‰ª§ÔºåAxios ËøîÂõûÁöÑÊòØ res.dataÔºåÁõ¥Êé•‰ΩøÁî® layoutResponse
        if (layoutResponse && layoutResponse.layout) {
            // ‰ªéAPIËé∑ÂèñÂèØÁî®ËΩ¶‰Ωç
            const allAreas = layoutResponse.layout
            availableSpots = allAreas.flatMap(area =>
                area.spots.filter(spot => spot.status === 'available').map(spot => spot.spot_number)
            )
        } else {
            // Â¶ÇÊûúAPIÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Â∏ÉÂ±Ä‰ø°ÊÅØÈöèÊú∫ÈÄâÊã©
            const allSpots = Object.values(parkingLayout.value).flat()
            availableSpots = allSpots.filter(spot => spot !== 'B03') // ÊéíÈô§Â∑≤Âç†Áî®ÁöÑËΩ¶‰Ωç
        }

        if (availableSpots.length > 0) {
            const randomSpot = availableSpots[Math.floor(Math.random() * availableSpots.length)]

            // Ë∞ÉÁî®ÂàÜÈÖçAPI
            const response = await autoAssignParkingSpot({
                user_id: userInfo.user_id,
                license_plate: licensePlate.value,
                vehicle_type: vehicleType.value,
                spot_number: randomSpot
            })

            // Ê†πÊçÆËá™ÂÆö‰πâÊåá‰ª§ÔºåAxios ËøîÂõûÁöÑÊòØ res.dataÔºåÁõ¥Êé•‰ΩøÁî® response
            if (response && response.success) {
                return {
                    spot_number: response.assigned_spot.number,
                    distance: response.distance || `${Math.floor(Math.random() * 200 + 50)}Á±≥`,
                    walk_time: response.walk_time || `${Math.floor(Math.random() * 3 + 1)}ÂàÜÈíü`
                }
            } else {
                // APIË∞ÉÁî®Â§±Ë¥•ÔºåËøîÂõûÊú¨Âú∞ÁîüÊàêÁöÑ‰ø°ÊÅØ
                return {
                    spot_number: randomSpot,
                    distance: `${Math.floor(Math.random() * 200 + 50)}Á±≥`,
                    walk_time: `${Math.floor(Math.random() * 3 + 1)}ÂàÜÈíü`
                }
            }
        }

        return null

    } catch (error) {
        console.error('ÈöèÊú∫ÂàÜÈÖçËΩ¶‰ΩçÂ§±Ë¥•:', error)
        return null
    }
}

// ÂÖ≥Èó≠WebSocketËøûÊé•
const closeWebSocket = () => {
    stopFrameCapture()
    if (wsClient.value) {
        wsClient.value.close()
        wsClient.value = null
    }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
onMounted(() => {
    initCamera()
    initWebSocket()
})

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
onUnmounted(() => {
    stopCurrentStream()
    closeWebSocket()
})
</script>

<style scoped lang="scss">
/* ÂÅúËΩ¶Âú∫Áº©Áï•ÂõæÊ†∑Âºè - ‰∏éadmin dashboard‰øùÊåÅ‰∏ÄËá¥ */
.parking-layout-thumbnail {
  position: relative;
}

.area-section {
  /* Âå∫ÂüüÊ†∑Âºè */
}

.parking-space-mini {
  width: 40px;
  height: 32px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  border: 2px solid transparent;
}

.parking-space-mini.available {
  background-color: #10b981;
  color: white;
  border-color: #059669;
}

.parking-space-mini.occupied {
  background-color: #ef4444;
  color: white;
  border-color: #dc2626;
}

.parking-space-mini.assigned {
  background-color: #fbbf24;
  color: #92400e;
  border-color: #f59e0b;
  animation: pulse-yellow 2s infinite;
  box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
}

.parking-space-mini:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.space-content-mini {
  text-align: center;
  font-size: 10px;
  font-weight: 600;
}

.space-id-mini {
  font-size: 10px;
  line-height: 1;
}

/* ÈªÑËâ≤ËÑâÂÜ≤Âä®Áîª */
@keyframes pulse-yellow {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.05);
  }
}

/* ÂìçÂ∫îÂºè‰ºòÂåñ */
@media (max-width: 768px) {
  .parking-space-mini {
    width: 32px;
    height: 24px;
  }

  .space-id-mini {
    font-size: 8px;
  }
}
</style>
